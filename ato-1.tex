%\documentclass[a4paper]{scrartcl}
\documentclass[a4paper]{article}
\usepackage{setspace}
\usepackage{url}
\usepackage{mdwlist}
\usepackage{polski}
\usepackage[utf8x]{inputenc}
\usepackage{color}
\usepackage{mathtools}
\usepackage{graphicx}
\usepackage[unicode=true]{hyperref}
\usepackage{multirow}
\usepackage[table]{xcolor}
\usepackage{subfig}
\usepackage{listings}
\usepackage[backgroundcolor=white]{todonotes}
\definecolor{dkgreen}{rgb}{0.2,0.8,0.2}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
\newcommand{\bsd}{\textbf{FreeBSD}}
\newcommand{\ssh}{\textbf{SSH}}
\newcommand{\rdp}{\textbf{rdesktop}}
\newcommand{\xbin}{\textbf{X}}
\newcommand{\xvnc}{\textbf{Xvnc}}
\newcommand{\wat}{\textbf{wat}}
\newcommand{\volt}{\textbf{volt}}
\lstset{ %
  basicstyle=\ttfamily\footnotesize,
  numbers=left,
  numberstyle=\footnotesize,
  stepnumber=1,
  numbersep=5pt,
  breaklines=true,
  tabsize=2,
  showspaces=false,
  showstringspaces=false,
  frame=single,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{mauve},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
}

\begin{document}
\begin{titlepage}

  \begin{center}


    % Upper part of the page
    \includegraphics[width=0.3\textwidth]{logo.jpg}\\[1cm]

    \begin{onehalfspace}
      \textsc{\LARGE Wydział Elektryczny Politechniki Warszawskiej}\\[1.5cm]
    \end{onehalfspace}



    \textsc{Sieci Komputerowe Lab.}\\[0.5cm]

    % Title
    \HRule \\[0.4cm]
    {\huge \bfseries Protokoły graficznych interfejsów użytkownika}\\[0.2cm]
    \HRule \\[1.5cm]

    % Author and supervisor
    \begin{flushleft} \large
      \emph{Autorzy:}\\
      Barnaba \textsc{Turek}\\
      \href{mailto:turekb@volt}{turekb@volt}\\
      Tomasz \textsc{Cudziło}\\
      \href{mailto:cudzilot@volt}{cudzilot@volt}\\
    \end{flushleft}
    \vfill

    % Bottom of the page
    {\large \today}

  \end{center}

\end{titlepage}
\sloppy

\setcounter{tocdepth}{4}
\tableofcontents

\section{Wstęp}
\section{Cel ćwiczenia}
Celem ćwiczenia było zapoznianie się z~systemami oprogramowania umożliwiającymi korzystanie z~graficznych interfejsów użytkownika poprzez sieć.
\section{Badane protokoły i~systemy oprogramowania}
Zapoznaliśmy się z~następującymi protokołami:
\begin{description}
  \item[X11] Protokół powstały dla systemów UN*X\dywiz owych, dostępny także na innych systemach. Korzystaliśmy z~programów \ssh, \xbin,
    a~także różnych skryptów pozwalających wygodnie zarządzać uwierzytelnianiem klientów.
  \item[RDP] Protokół wspierany przez systemy z~rodziny \emph{Windows}. Korzystaliśmy z~klienta \rdp, i~maszyny \wat{} jako serwera.
  \item[VNC] Popularny protokół zdalnego dostępu. Korzystaliśmy z~\xvnc{} jako serwera, a~także z~klientów \textbf{tightVNC} i \textbf{Tiger VNC}.
\end{description}

\section{X11}
\subsection{Opis rozwiązania}
Serwer X organizuje komunikację pomiędzy klientami (programami, które chcą wyświetlać informacje na ekranach) a~sprzętem.
Serwer przyjmuje polecenia rysowania elementów interfejsu od klientów i~w~wyniku tych poleceń rysuje elementy na ekranie, z~którym jest związany.

Poza tym serwer obsługuje urządzenia wejściowe (takie jak klawiatury i~myszki) i~przesyła wygenerowane przez nie zdarzenia do klientów.

Zastosowany model klienta\dywiz serwera pozwala więc na zdalne uruchamianie aplikacji graficznych.

W~ramach ćwiczenia uruchomiliśmy serwer X na lokalnej maszynie (przyniesionym laptopie z~systemem Ubuntu lub maszynie laboratoryjnej).
Następnie do uruchomionego serwera podłączaliśmy klientów (programy). Udało nam się uruchomić klientów graficznych z~maszyny \volt oraz przyniesionego laptopa.

\subsection{Przygotowanie}
Po zalogowaniu się na maszynie laboratoryjnej wykonaliśmy następujące polecenia:
\todo{listing poleceń}

Zamontowanie katalogu domowego, w~którym możemy tworzyć pliki jest niezbędne, jeśli chcemy skorzystać ze skryptu \textbf{startx}.
Skrypt ten ustawia zmienną środowiskową \texttt{XAUTHORITY} na ścieżkę w katalogu domowym użytkownika (nawet gdyby nie ustawiał, jest to domyślna wartość przyjmowana przez serwer).

\begin{lstlisting}[caption=fragment skryptu startx]
    if [ x"$XAUTHORITY" = x ]; then
        XAUTHORITY=$HOME/.Xauthority
        export XAUTHORITY
    fi
\end{lstlisting}

\subsubsection{Uruchomienie serwera X}
Zgodnie ze stroną \texttt{man 7 X} plik wskazany przez tą zmienną zostanie użyty do zapisania klucza, pozwalającego uwierzytelnić klienta.

W katalogu domowym jest także tworzony plik \texttt{.serverauth.*}, który jest wykorzystywany do przekazania klucza do serwera.

\subsubsection{Uwierzytelnianie}
Skrypt startx uruchamia serwer X korzystający z prostej metody uwierzytelniania klientów: \texttt{MIT-MAGIC-COOKIE-1}.
Polega ona na tym, że zarówno klient jak i serwer znają to samo 16-sto bajtowe haslo, podawane serwerowi w czasie jego uruchomienia.
Hasło jest pomiędzy nimi przekazywane za pomocą czystego tekstu (czyli możliwe do łatweo podsłuchania)
\begin{lstlisting}[caption={ fragmenty skryptu startx generujące współdzielony klucz, zapisujące go w pliku i dodające ten plik do argumentów wywołania serwera X }]
    if [ -r /dev/urandom ]; then
        mcookie=`dd if=/dev/urandom bs=16 count=1 2>/dev/null | /usr/bin/hexdump -e \\"%08x\\"`
    else
        mcookie=`dd if=/dev/random bs=16 count=1 2>/dev/null | /usr/bin/hexdump -e \\"%08x\\"`
    fi

    [...]

    dummy=0

    # create a file with auth information for the server. ':0' is a dummy.
    xserverauthfile=$HOME/.serverauth.$$
    trap "rm -f '$xserverauthfile'" HUP INT QUIT ILL TRAP KILL BUS TERM
    xauth -q -f "$xserverauthfile" << EOF
add :$dummy . $mcookie
EOF

    serverargs=${serverargs}" -auth "${xserverauthfile}

\end{lstlisting}

Możliwe są także inne metody uwierzytelniania, opisane szczegółowo w \texttt{man 7 Xsecurity}, jednak nie zapoznaliśmy się z nimi bliżej.
Niektóre z nich wyglądają na bezpieczniejsze.

Po uruchomieniu serwera skorzystaliśmy ze skryptu \texttt{xauth-export}, który wywołuje polecenie \texttt{xauth}, wydobywa z niego klucz, a następnie wgrywa go na zadaną maszynę za pomocą protokołu \emph{SCP}.
Wgraliśmy wygenerowany klucz na maszynę, na której uruchamialiśmy zdalnego klienta.

Alternatywą do korzystanie z~tego skryptu byłoby skopiowanie wartości z~pliku wskazywanego przez zmienną \texttt{XAUTHORITY} i~wklejenie ich do odpowiedniego pliku na maszynie docelowej.
Mogliśmy też uruchomić skrypt \texttt{home} bez argumentów, tak by katalog domowy został zamontowany z~maszyny \volt. Wtedy plik \texttt{~/.Xauthority} byłby dzielony pomiędzy maszynami.

\subsubsection{Wybór serwera X dla klienta}

Ostatnia czynność którą musieliśmy wykonać przed uruchomieniem klienta (już na zdalnej maszynie), to ustawienie zmiennej środowiskowej \texttt{DISPLAY}.
Zmienna ta, wg. \texttt{man 7 X} określa, z~którego serwera Xów chcemy korzystać (serwer jest określony przez nazwę hosta i~numer, który przekłada się bezpośrednio na port, na który otwierane jest połączenie z~serwerem), oraz na którym ekranie chcemy wyświetlić naszego klienta.

\texttt{Man 7 X} wspomina, że alternatywą do ustawiania zmiennej środowiskowej \texttt{DISPLAY} jest podanie programowi argumentu \texttt{-display}.
Wiele programów nie obsługuje tego argumentu.

\subsection{Alternatywa - \texttt{ssh -X}}
Program \ssh{} posiada wbudowane rozwiązanie upraszczające proces, przez który przeszliśmy.

Aby to rozwiązanie zadziałało, przed otwarciem połączenia \ssh{} powłoka, z~której otwieramy połączenie musi mieć poprawnie ustawione zmienne środowiskowe związane z~serwerem X
(t.j. zmienną \texttt{DISPLAY} i~metodę uwierzytelniania na tym serwerze).

Jeśli to założenie jest spełnione, to wykonanie polecenia \ssh z~opcją \texttt{-X} automatycznie ustawi na docelowym komputerze poprawną wartość zmiennej \texttt{DISPLAY} i~poprawną metodę uwierzytelniania (wraz z~kluczem).
Na codzień korzystamy z~tej opcji do wygodnego drukowania plików PDF na serwerze \volt{} za pomocą programu \emph{evince}.
W~czasie laboratorium nie sprawiła nam żadnych problemów

\section{RDP}
\todo{Tutaj możemy chyba dać tylko listing, warto wspomnieć o~haxopcjach linii komend których użyliśmy}
\section{VNC}
\todo{Warto zaznaczyć, że w~przeciwieństwie do windowsów nie łączymy się z~istniejącym ekranem, tylko dostajemy nowy. Że standardowo się forkuje i~trzeba go zabić etc.}

\end{document}

%fragmenty do copypastowania

\begin{figure}[h]
  \centering
  \includegraphics[width=0.8\textwidth]{asd.png}
  \caption{}
\end{figure}

\begin{lstlisting}[caption=Przykład]
  kod
\end{lstlisting}
